{
  "$id": "file://battmo/schemas/linearsolver",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "description": "linear solver",
  "type": "object",
  "properties" : {"library" : {"type" : "string",
                               "description" : "name of the solver library",
                               "$ref": "#/$defs/solver_library"
                              },
                  
                  "method" : {"type" : "string",
                              "description" : "name of the method used by the solver - depends on the chosen library. if not given a default solver for the library is given"
                             },
                  
                  "options" : {"type" : "object",
                               "description" : "options required - depends on the chosen library and mehod"},

                  "reduction" : {"type" : "object",
                                 "properties" : {"doReduction": {"type" : "boolean"},
                                                 "description" : "The reduction of Control.I and Control.E is done conditionally",
                                                 "variables" : {"type" : "array",
                                                                "description" : "list of the variables that will be eliminated before inverting the linear system",
                                                                "items" : {"type" : "object",
                                                                           "properties" : {"name" : {"$ref" : "#/$defs/variable"},
                                                                                           "order" : {"type" : "integer",
                                                                                                      "description" : "gives order in which reduction should be done"},
                                                                                           "special" : {"type" : "boolean"},
                                                                                           "description" : "If special is true, it reminds  us that some variables such as Control.I and Control.E can  be  reduced or not depending on the type of control that is active"}
                                                                          }
                                                               }
                                                }
                                }
                 },


  "oneOf" : [{"properties" : {"library" : {"const" : "matlab"}},

              "description" : "We have the following methods for the matlab solver. If no method is given, a direct solver is used",

              "anyOf": [

                {"properties" : {"method" : {"const": "direct"}}},


                {"properties" : {"method" : {"const" : "grouped-gmres"},
                                 "description" : "we run gmres on the whole system with one preconditioner",
                                 "preconditioner" : {"$ref" : "#"}}},

                 
                {"properties" : {"method" : {"const" : "separate-variable-gmres"},
                                 "description" : "We use separate preconditioner for chosen variables",
                                 "preconditioners" : {"$ref" : "#/$defs/separate_variable_preconditioners"}}},

                {"not" : {"properties" : {"method" : {"enum" : ["direct", "grouped-gmres", "separate-variable-gmres"]}}},
                 "description" : "if no method is given, the direct solver is used"}
                
              ]
             },
             
             {"properties" : {"library" : {"const" : "agmg"}},
              
              "description" : "We can use either standard method (gmres) or separate with variable",
              
              "oneOf": [
                
                {"properties" : {"method" : {"const": "standard"},
                                 "descrtion": "solve until convergence"}},

                {"properties" : {"method" : {"const": "amg"},
                                 "description" : "only one iteration"}},
                
                {"properties" : {"method" : {"const" : "separate-variable-gmres"},
                                 "description" : "We use separate preconditioner for chosen variables",
                                 "preconditioners" : {"$ref": "#/$defs/separate_variable_preconditioners"}}}
              ]
              
             },
             

             
             {"allOf" : [{"properties" : {"library" : {"const" : "amgcl"}}},
                         {"$ref" : "amgclOptions"}
                         ]
             }
             
            ],
  
  "$defs" : { "solver_library" : {"type" : "string",
                                  "description" : "list of (partially) supported linear solver library",
                                  "enum" : ["matlab", "agmg", "amgcl"]},
              
              "variable" : {"type" : "array",
                            "items" : {"type" : "string"}},


              "separate_variable_preconditioners" : {"type" : "array",
                                                     "description" : "array of solvers for the variables",
                                                     "items" : {"type" : "object",
                                                                "properties" : {"variables" : {"type" : "array",
                                                                                               "items" : {"$ref" : "#/$defs/variable"}
                                                                                              },
                                                                                "solver" : {"$ref" : "#"}
                                                                               }
                                                               }
                                                    }
            }
  
}  



