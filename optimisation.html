<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Optimization &mdash; BattMo  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx_collapse.css" />
      <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />

  
    <link rel="shortcut icon" href="_static/battmologo.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/design-tabs.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Note on Octave Support" href="octave.html" />
    <link rel="prev" title="Thermal Simulation" href="thermal.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            BattMo
              <img src="_static/battmologo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="basicusage.html">Basic Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="basicusage.html#a-first-battmo-model">A First <strong>BattMo</strong> Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="basicusage.html#define-parameters">Define Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="basicusage.html#run-simulation">Run Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="basicusage.html#show-the-dashboard">Show the Dashboard</a></li>
<li class="toctree-l3"><a class="reference internal" href="basicusage.html#explore-the-output">Explore the Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="basicusage.html#explore-the-grid">Explore the Grid</a></li>
<li class="toctree-l3"><a class="reference internal" href="basicusage.html#explore-the-states">Explore the States</a></li>
<li class="toctree-l3"><a class="reference internal" href="basicusage.html#plot-a-result">Plot a Result</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="basicusage.html#change-control-parameters">Change Control Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="basicusage.html#change-structural-parameters">Change Structural Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="basicusage.html#change-material-parameters">Change Material Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="basicusage.html#notebooks">Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="basicusage.html#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="intermediate.html">Intermediate usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="intermediate.html#setup-a-p4d-model-using-mergejsonstructs">Setup a P4D Model using <code class="code docutils literal notranslate"><span class="pre">mergeJsonStructs</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="intermediate.html#define-parameters">Define Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="intermediate.html#run-simulation">Run Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="intermediate.html#visualize-results">Visualize Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="intermediate.html#file-links-and-insertions-with-parsebattmojson">File links and insertions with <code class="code docutils literal notranslate"><span class="pre">parseBattmoJson</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">BattMo Model Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="json.html">JSON input specification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="json.html#simulation-schema">Simulation Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="json.html#material-parameters">Material Parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="json.html#electrolyte">Electrolyte</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#electrode">Electrode</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#coating">Coating</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#active-material">Active Material</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#interface">Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#solid-diffusion">Solid Diffusion</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#full-solid-diffusion">Full Solid Diffusion</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#binder">Binder</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#conducting-additive">Conducting Additive</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#current-collector">Current Collector</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#separator">Separator</a></li>
<li class="toctree-l3"><a class="reference internal" href="json.html#thermal-model">Thermal Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="json.html#geometry-setup">Geometry Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="json.html#simulation-control-parameters">Simulation Control Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="json.html#time-stepping-parameters">Time Stepping Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="json.html#solver-parameters">Solver Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="json.html#output-parameters">Output Parameters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="geometryinput.html">Battery Geometries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="geometryinput.html#batterygeneratorp2d">BatteryGeneratorP2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometryinput.html#batterygeneratorp3d">BatteryGeneratorP3D</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometryinput.html#batterygeneratorp4d">BatteryGeneratorP4D</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometryinput.html#spiralbatterygenerator">SpiralBatteryGenerator</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometryinput.html#coincellbatterygenerator">CoinCellBatteryGenerator</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometryinput.html#batterygeneratormultilayerpouch">BatteryGeneratorMultilayerPouch</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="advancedtopics.html">Advanced Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="modelinitialisation.html">The Battery Simulation Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="modelinitialisation.html#initialisation-of-a-battery-simulation-model">Initialisation of a battery simulation model</a></li>
<li class="toctree-l3"><a class="reference internal" href="modelinitialisation.html#inspection-of-the-model">Inspection of the model</a></li>
<li class="toctree-l3"><a class="reference internal" href="modelinitialisation.html#computing-and-inspecting-some-standard-static-properties-of-the-model">Computing and inspecting some standard static properties of the model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="controlinput.html">Control models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="controlinput.html#json-input-control-interface">Json input control interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="controlinput.html#control-model-description">Control model description</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="soliddiffusion.html">Solid Diffusion Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="parsets.html">Parameter sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="units.html">Units</a><ul>
<li class="toctree-l3"><a class="reference internal" href="units.html#converting-units-in-battmo">Converting units in BattMo</a></li>
<li class="toctree-l3"><a class="reference internal" href="units.html#units-and-json-input">Units and JSON input</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="thermal.html">Thermal Simulation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#parameter-identification-example">Parameter identification example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimization-example">Optimization example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="octave.html">Octave</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="juliabridge.html">BattMo Julia bridge</a><ul>
<li class="toctree-l2"><a class="reference internal" href="juliabridge.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="juliabridge.html#start-server">Start Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="juliabridge.html#send-simulation-parameters">Send simulation parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="juliabridge.html#run-the-simulation">Run the simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="juliabridge.html#post-process-the-output">Post process the output</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="publishedExamples/runElectrolyser.html">Electrolyser simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#load-mrst-modules">Load MRST modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#setup-input">Setup input</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#setup-model">Setup model</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#setup-the-initial-condition">Setup the initial condition</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#setup-the-schedule-with-the-time-discretization">Setup the schedule with the time discretization</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#setup-the-non-linear-solver">Setup the non-linear solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#run-the-simulation">Run the simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#visualize-the-results">Visualize the results</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runElectrolyser.html#ph-distribution-plot">pH distribution plot</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html">Protonic Membrane</a><ul>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#model-overview">Model overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#governing-equations">Governing equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#boundary-conditions">Boundary conditions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#load-and-parse-input-from-given-json-files">Load and parse input from given json files</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#input-structure-setup">Input structure setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#model-setup">Model setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#initial-state-setup">Initial state setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#schedule-schedule">Schedule schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#simulation">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="publishedExamples/runProtonicMembrane.html#plotting">Plotting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gui.html">BattMo App</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gui_features.html">Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="gui_features.html#use-default-materials">Use default materials</a></li>
<li class="toctree-l3"><a class="reference internal" href="gui_features.html#define-your-own-materials">Define your own materials</a></li>
<li class="toctree-l3"><a class="reference internal" href="gui_features.html#visualize-your-geometry">Visualize your geometry</a></li>
<li class="toctree-l3"><a class="reference internal" href="gui_features.html#download-your-input-data">Download your input data</a></li>
<li class="toctree-l3"><a class="reference internal" href="gui_features.html#visualize-and-download-your-results">Visualize and download your results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gui_calculations.html">Calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="gui_troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="gui_troubleshooting.html#unnatural-artifacts-in-your-results">Unnatural artifacts in your results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="computationalGraph/graphdoc.html">Computational Graph</a><ul>
<li class="toctree-l2"><a class="reference internal" href="computationalGraph/graphdoc.html#a-simple-introduction-example">A simple introduction example</a></li>
<li class="toctree-l2"><a class="reference internal" href="computationalGraph/graphdoc.html#graph-composition">Graph composition</a></li>
<li class="toctree-l2"><a class="reference internal" href="computationalGraph/graphdoc.html#graph-setup-and-implementation">Graph Setup and Implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="seealso.html">See Also</a><ul>
<li class="toctree-l2"><a class="reference internal" href="seealso.html#mrst">MRST</a><ul>
<li class="toctree-l3"><a class="reference internal" href="seealso.html#visualization">Visualization Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="seealso.html#id2">Grid Factory Tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="seealso.html#fair-data">FAIR Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BattMo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="advancedtopics.html">Advanced Usage</a></li>
      <li class="breadcrumb-item active">Optimization</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/optimisation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="optimization">
<h1>Optimization<a class="headerlink" href="#optimization" title="Permalink to this heading"></a></h1>
<p>The topic of optimization does not only involve finding the parameters
that maximizes some output quantity such as the energy
output. Optimization, from a mathematical viewpoint, also involve
fitting parameters in the numerical model against data, for example
provided by experiments. This procedure has many names, including
“fitting”, “parameterization”, “calibration” and “parameter
identification”. We will here present an example of parameter
identification followed by an example of optimization.</p>
<section id="parameter-identification-example">
<h2>Parameter identification example<a class="headerlink" href="#parameter-identification-example" title="Permalink to this heading"></a></h2>
<p>The complete source code of this example can be found at
<a class="reference external" href="https://github.com/BattMoTeam/BattMo/blob/dev/Examples/Optimisation/runParameterIdentification.m">runParameterIdentification</a>.</p>
<p>As often, we start by defining our MRST modules and some convenient
short names. In particular, we instantiate the <cite>optimization</cite> module,
which provides the key classes and functions for performing
optimization.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">mrstModule</span><span class="w"> </span><span class="s">add</span><span class="w"> </span><span class="s">ad-core</span><span class="w"> </span><span class="s">optimization</span><span class="w"> </span><span class="s">mpfa</span><span class="w"> </span><span class="s">mrst-gui</span>

<span class="nb">clear</span>
<span class="nb">close</span><span class="w"> </span><span class="nb">all</span>

<span class="n">ne</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;NegativeElectrode&#39;</span><span class="p">;</span>
<span class="n">pe</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;PositiveElectrode&#39;</span><span class="p">;</span>
<span class="n">elyte</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Electrolyte&#39;</span><span class="p">;</span>
<span class="n">thermal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;ThermalModel&#39;</span><span class="p">;</span>
<span class="n">am</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;ActiveMaterial&#39;</span><span class="p">;</span>
<span class="n">co</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Coating&#39;</span><span class="p">;</span>
<span class="n">itf</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Interface&#39;</span><span class="p">;</span>
<span class="n">sd</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;SolidDiffusion&#39;</span><span class="p">;</span>
<span class="n">ctrl</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Control&#39;</span><span class="p">;</span>
<span class="n">sep</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Separator&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>Then we set up the battery: the chemistry, the geometry, how it is
operated (the control) and the time stepping, as discussed in the
other tutorials. Here, an option for validating the json struct is
included but set to false by default since the validation requires
MATLAB to call Python, which in turn requires a compatible Python
version installed. If you are interested in testing this, set the flag
to true.</p>
<p>In addition there is commented code for setting up a finer time
discretization. This is because later in the tutorial we will see the
effect of using a finer time discretization and stricter tolerances.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">jsonParams</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">parseBattmoJson</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="s">&#39;ParameterData&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;BatteryCellParameters&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;LithiumIonBatteryCell&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;lithium_ion_battery_nmc_graphite.json&#39;</span><span class="p">));</span>
<span class="n">jsonGeom</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="n">parseBattmoJson</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="s">&#39;Examples&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;JsonDataFiles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;geometry1d.json&#39;</span><span class="p">));</span>
<span class="n">jsonControl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parseBattmoJson</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="s">&#39;Examples&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;JsonDataFiles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;cc_discharge_control.json&#39;</span><span class="p">));</span>
<span class="n">jsonSim</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">parseBattmoJson</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="s">&#39;Examples&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;JsonDataFiles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;simulation_parameters.json&#39;</span><span class="p">));</span>

<span class="n">json</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mergeJsonStructs</span><span class="p">({</span><span class="n">jsonParams</span><span class="p">,</span><span class="w"> </span><span class="n">jsonGeom</span><span class="p">,</span><span class="w"> </span><span class="n">jsonControl</span><span class="p">,</span><span class="w"> </span><span class="n">jsonSim</span><span class="p">});</span>

<span class="n">json</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">useCVswitch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="c">% % Test finer time discretization</span>
<span class="c">% json.TimeStepping.numberOfTimeSteps = 80;</span>
<span class="c">% json.TimeStepping.numberOfRampupSteps = 10;</span>

<span class="c">% Optionally validate the json struct</span>
<span class="n">validateJson</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</pre></div>
</div>
<p>The json struct completely specifies the simulation. We simulate the
model and save the output in a conventient data structure. This will
form the initial data for the parameter identification later on.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">json0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">json</span><span class="p">;</span>
<span class="n">output0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">runBatteryJson</span><span class="p">(</span><span class="n">json0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;validateJson&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">validateJson</span><span class="p">);</span>

<span class="n">simSetup</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;model&#39;</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="n">output0</span><span class="p">.</span><span class="n">model</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                  </span><span class="s">&#39;schedule&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">output0</span><span class="p">.</span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                  </span><span class="s">&#39;state0&#39;</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">output0</span><span class="p">.</span><span class="n">initstate</span><span class="p">);</span>
</pre></div>
</div>
<p>In this example we will fit five parameters:</p>
<ul class="simple">
<li><p>the Bruggeman coefficient for the electrolyte</p></li>
<li><p>the exchange current densities for both electrodes</p></li>
<li><p>the volumetric surface areas for both electrodes</p></li>
</ul>
<p>To set up these parameters in the fitting, we use the <cite>ModelParameter</cite>
class in MRST. As can be seen in the source code found at
<a class="reference external" href="https://bitbucket.org/mrst/mrst-autodiff/src/battmo-dev/optimization/utils/ModelParameter.m">ModelParameter</a>,
there are a several options that can be set. The most important ones are the ones used here:</p>
<ul class="simple">
<li><p>the name of the parameter (arbitrary)</p></li>
<li><p>the object to which the parameter belongs (usually model)</p></li>
<li><p>the <cite>boxLims</cite>, which sets hard constraints for the range of the parameters</p></li>
<li><p>the scaling, which is linear per default, but may be logarithmic</p></li>
<li><p>the location of the parameter in the object (model)</p></li>
</ul>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">params</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addParameter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">            </span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;elyte_bruggeman&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">            </span><span class="s">&#39;belongsTo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">            </span><span class="s">&#39;boxLims&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">            </span><span class="s">&#39;location&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">elyte</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;bruggemanCoefficient&#39;</span><span class="p">});</span>

<span class="c">% Exchange current densities in the Butler-Volmer eqn</span>
<span class="n">params</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addParameter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;ne_k0&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;belongsTo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;scaling&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;boxLims&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">1e-12</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;location&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">ne</span><span class="p">,</span><span class="w"> </span><span class="n">co</span><span class="p">,</span><span class="w"> </span><span class="n">am</span><span class="p">,</span><span class="w"> </span><span class="n">itf</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;reactionRateConstant&#39;</span><span class="p">});</span>
<span class="n">params</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addParameter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pe_k0&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;belongsTo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;scaling&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;boxLims&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">1e-12</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;location&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">pe</span><span class="p">,</span><span class="w"> </span><span class="n">co</span><span class="p">,</span><span class="w"> </span><span class="n">am</span><span class="p">,</span><span class="w"> </span><span class="n">itf</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;reactionRateConstant&#39;</span><span class="p">});</span>

<span class="c">% Volumetric surface areas</span>
<span class="n">params</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addParameter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;ne_vsa&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;belongsTo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;boxLims&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">1e5</span><span class="p">,</span><span class="w"> </span><span class="mf">1e7</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;location&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">ne</span><span class="p">,</span><span class="w"> </span><span class="n">co</span><span class="p">,</span><span class="w"> </span><span class="n">am</span><span class="p">,</span><span class="w"> </span><span class="n">itf</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;volumetricSurfaceArea&#39;</span><span class="p">});</span>
<span class="n">params</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addParameter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pe_vsa&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;belongsTo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;boxLims&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">1e5</span><span class="p">,</span><span class="w"> </span><span class="mf">1e7</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="s">&#39;location&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">pe</span><span class="p">,</span><span class="w"> </span><span class="n">co</span><span class="p">,</span><span class="w"> </span><span class="n">am</span><span class="p">,</span><span class="w"> </span><span class="n">itf</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;volumetricSurfaceArea&#39;</span><span class="p">});</span>
</pre></div>
</div>
<p>In the next step we generate what we may call “experimental” data,
i.e. data that we will calibrate against (as we will shortly seen, we
will use the “experimental” voltage E_exp and current I_exp). This
data is generated by running a simulation with average values of the
<cite>boxLims</cite> as values for the parameters in <cite>params</cite>. This makes the
resulting optimization problem very easy to solve, but still
illustrates the basic workflow of setting up parameter identification
problems.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">jsonExp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">json</span><span class="p">;</span>
<span class="n">pExp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="nb">numel</span><span class="p">(</span><span class="n">params</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="w">  </span><span class="n">loc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">{</span><span class="n">ip</span><span class="p">}.</span><span class="n">location</span><span class="p">;</span>
<span class="w">  </span><span class="n">orig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">{</span><span class="n">ip</span><span class="p">}.</span><span class="n">getfun</span><span class="p">(</span><span class="n">simSetup</span><span class="p">.(</span><span class="n">params</span><span class="p">{</span><span class="n">ip</span><span class="p">}.</span><span class="n">belongsTo</span><span class="p">),</span><span class="w"> </span><span class="n">loc</span><span class="p">{:});</span>
<span class="w">  </span><span class="n">new</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">params</span><span class="p">{</span><span class="n">ip</span><span class="p">}.</span><span class="n">boxLims</span><span class="p">);</span>
<span class="w">  </span><span class="n">jsonExp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">{</span><span class="n">ip</span><span class="p">}.</span><span class="n">setfun</span><span class="p">(</span><span class="n">jsonExp</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">{:},</span><span class="w"> </span><span class="n">new</span><span class="p">);</span>
<span class="w">  </span><span class="n">pExp</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="p">;</span>
<span class="k">end</span>
<span class="n">outputExp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">runBatteryJson</span><span class="p">(</span><span class="n">jsonExp</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;validateJson&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">validateJson</span><span class="p">);</span>
</pre></div>
</div>
<p>Next we set up the objective function, i.e. the function we seek to
minimize by varying the parameters <cite>params</cite>. We set this to be a least
squares function of the differences of the “experimental” values and
the values that will be obtained during the optimization. The least
squares function here is formed by both the voltages E and the
currents I: obj(E, I) = ||E - E_exp||^2 + ||I - I_exp||^2.</p>
<p>To make sure the objective function is correct, we test it by
evaluating it using the generated “experimental” values to make sure
it is zero.</p>
<p>Physics-based models are often costly to simulate accurately, because
they are often large and nonlinear. Since multiple evaluations of the
model must likely be done during optimization, we want an algorithm
that is as efficient as possible in the sense that we want to evaluate
the model as few times as possible. One approach for accomplishing
this is to take information from the gradients into account, so-called
gradient-based optimization methods. The function that will compute
the gradients of the objective function with respect to <cite>params</cite> is
also set up here. Under the hood, BattMo will compute these by
solving the adjoint problem.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Objective function</span>
<span class="n">objective</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">)</span><span class="w"> </span><span class="n">leastSquaresEI</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">outputExp</span><span class="p">.</span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">{:});</span>

<span class="c">% Debug: the objective function evaluated at the experimental values</span>
<span class="c">% should be zero</span>
<span class="n">objval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">objective</span><span class="p">(</span><span class="n">outputExp</span><span class="p">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">outputExp</span><span class="p">.</span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">outputExp</span><span class="p">.</span><span class="n">schedule</span><span class="p">);</span>
<span class="nb">assert</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">([</span><span class="n">objval</span><span class="p">{:}]))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>

<span class="c">% Function for gradient computation</span>
<span class="n">objVals</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">objective</span><span class="p">(</span><span class="n">output0</span><span class="p">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">output0</span><span class="p">.</span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">output0</span><span class="p">.</span><span class="n">schedule</span><span class="p">);</span>
<span class="n">objScaling</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">([</span><span class="n">objVals</span><span class="p">{:}]);</span>
<span class="n">objectiveGradient</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">evalObjectiveBattmo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">objective</span><span class="p">,</span><span class="w"> </span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;objScaling&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">objScaling</span><span class="p">);</span>
</pre></div>
</div>
<p>To make sure the adjoint gradients are correct, we can compare them
with gradients calculated by a classical finite difference
approximation. The relative difference between them should not be too
large, and it can also be useful to simply look at the sign. This is
such a basal check that during development, the commented <cite>return</cite>
statement below can be uncommented until the objective function is
correctly set up.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">debug</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="n">debug</span>
<span class="w">  </span><span class="n">pTmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getScaledParameterVector</span><span class="p">(</span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>

<span class="w">  </span><span class="p">[</span><span class="n">vad</span><span class="p">,</span><span class="w"> </span><span class="n">gad</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">evalObjectiveBattmo</span><span class="p">(</span><span class="n">pTmp</span><span class="p">,</span><span class="w"> </span><span class="n">objective</span><span class="p">,</span><span class="w"> </span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                   </span><span class="s">&#39;gradientMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;AdjointAD&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="p">[</span><span class="n">vnum</span><span class="p">,</span><span class="w"> </span><span class="n">gnum</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">evalObjectiveBattmo</span><span class="p">(</span><span class="n">pTmp</span><span class="p">,</span><span class="w"> </span><span class="n">objective</span><span class="p">,</span><span class="w"> </span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                               </span><span class="s">&#39;gradientMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;PerturbationADNUM&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                               </span><span class="s">&#39;PerturbationSize&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-7</span><span class="p">);</span>
<span class="w">  </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Adjoint and finite difference derivatives and the relative error\n&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nb">disp</span><span class="p">([</span><span class="n">gad</span><span class="p">,</span><span class="w"> </span><span class="n">gnum</span><span class="p">,</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">gad</span><span class="o">-</span><span class="n">gnum</span><span class="p">)</span><span class="o">./</span><span class="nb">abs</span><span class="p">(</span><span class="n">gad</span><span class="p">)])</span>

<span class="w">  </span><span class="c">%return</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Now we are ready to perform the optimization. We use the well-tested,
efficient BFGS method with the parameters set by <cite>params</cite>. The initial
guess is deduced from the <cite>belongsTo</cite> and <cite>location</cite> properties in the
<cite>params</cite> vector. Note that the parameters are actually scaled to <cite>[0,
1]</cite> using the <cite>boxLims</cite>. After the optimization, these will be scaled
back.</p>
<p>We may set up several criteria for the BFGS method to terminate:</p>
<ul class="simple">
<li><p><cite>gradTol</cite>: BFGS terminates if the gradient is less than this value.</p></li>
<li><p><cite>objChangeTol</cite>: BFGS terminates if the change in the objective function is less than this value.</p></li>
<li><p><cite>maxIt</cite>: BFGS terminates after these many iterations.</p></li>
</ul>
<p>Also note that we set <cite>maximize=false</cite>, since we perform a
minimization: we want to minimize the least squares functional.</p>
<p>Note that we have commented out a stricter value for
<cite>objChangeTol</cite>. It is of great interest to see how using this value in
combination with the finer temporal discretization will change the
result. In fact, numerous numerical properties influence the
optimization. Not only the parameters of the BFGS method, but also the
space and time discretization parameters and solver tolerances also
may play a role.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">p0scaled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getScaledParameterVector</span><span class="p">(</span><span class="n">simSetup</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="n">gradTol</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e-7</span><span class="p">;</span>
<span class="n">objChangeTol</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">;</span>
<span class="c">%objChangeTol = 1e-7;</span>
<span class="n">maxIt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span>
<span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">pOptTmp</span><span class="p">,</span><span class="w"> </span><span class="n">history</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">unitBoxBFGS</span><span class="p">(</span><span class="n">p0scaled</span><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="n">objectiveGradient</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                    </span><span class="s">&#39;maximize&#39;</span><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                    </span><span class="s">&#39;gradTol&#39;</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="n">gradTol</span><span class="w">          </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                    </span><span class="s">&#39;objChangeTol&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">objChangeTol</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                    </span><span class="s">&#39;maxIt&#39;</span><span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="n">maxIt</span><span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                    </span><span class="s">&#39;logplot&#39;</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="n">numIt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
</pre></div>
</div>
<p>After waiting for BFGS to finish (a couple of minutes on a standard
laptop), we run the model with the optimized parameters, optionally
plot the result and display the relative difference between the
“experimental”, and optimized values.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">jsonOpt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">json</span><span class="p">;</span>

<span class="k">for</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="w">    </span><span class="n">loc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">{</span><span class="n">ip</span><span class="p">}.</span><span class="n">location</span><span class="p">;</span>
<span class="w">    </span><span class="n">jsonOpt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">{</span><span class="n">ip</span><span class="p">}.</span><span class="n">setfun</span><span class="p">(</span><span class="n">jsonOpt</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">{:},</span><span class="w"> </span><span class="n">pOpt</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>
<span class="k">end</span>

<span class="n">outputOpt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">runBatteryJson</span><span class="p">(</span><span class="n">jsonOpt</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;validateJson&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">validateJson</span><span class="p">);</span>

<span class="c">%%</span>
<span class="n">do_plot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="n">do_plot</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;defaultlinelinewidth&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">    </span><span class="n">getTime</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">states</span><span class="p">)</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="w">    </span><span class="n">getE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">states</span><span class="p">)</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>

<span class="w">    </span><span class="n">t0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getTime</span><span class="p">(</span><span class="n">output0</span><span class="p">.</span><span class="n">states</span><span class="p">);</span>
<span class="w">    </span><span class="n">E0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getE</span><span class="p">(</span><span class="n">output0</span><span class="p">.</span><span class="n">states</span><span class="p">);</span>
<span class="w">    </span><span class="n">tOpt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getTime</span><span class="p">(</span><span class="n">outputOpt</span><span class="p">.</span><span class="n">states</span><span class="p">);</span>
<span class="w">    </span><span class="n">EOpt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getE</span><span class="p">(</span><span class="n">outputOpt</span><span class="p">.</span><span class="n">states</span><span class="p">);</span>
<span class="w">    </span><span class="n">tExp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getTime</span><span class="p">(</span><span class="n">outputExp</span><span class="p">.</span><span class="n">states</span><span class="p">);</span>
<span class="w">    </span><span class="n">EExp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getE</span><span class="p">(</span><span class="n">outputExp</span><span class="p">.</span><span class="n">states</span><span class="p">);</span>

<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">figure</span><span class="p">;</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="n">grid</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="n">axis</span><span class="w"> </span><span class="s">tight</span>
<span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="n">t0</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">E0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;displayname&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;E_{0}&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="n">tExp</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">EExp</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;--&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;displayname&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;E_{exp}&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="n">tOpt</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">EOpt</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;displayname&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;E_{opt}&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">legend</span><span class="p">;</span>

<span class="k">end</span>

<span class="c">%% Summarize</span>
<span class="n">pOrig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">simSetup</span><span class="p">),</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>

<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Initial guess:\n&#39;</span><span class="p">);</span>
<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;%g\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pOrig</span><span class="p">);</span>

<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Fitted values (* means we hit the box limit):\n&#39;</span><span class="p">);</span>
<span class="n">tol</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="w">    </span><span class="n">hit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">pOptTmp</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tol</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">pOptTmp</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tol</span>
<span class="w">        </span><span class="n">hit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;*&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;%g %s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pOpt</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">hit</span><span class="p">);</span>
<span class="k">end</span>

<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;\nExperimental values:\n&#39;</span><span class="p">);</span>
<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;%g\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pExp</span><span class="p">);</span>

<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;\nRelative error between optimized and experimental values:\n&#39;</span><span class="p">)</span>
<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;%g\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">relErr</span><span class="p">);</span>

<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;\nIterations:\n&#39;</span><span class="p">)</span>
<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;%g\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">numIt</span><span class="p">);</span>
</pre></div>
</div>
<p>The exact values obtained may depend how default parameters of BattMo
are set, but at the time of writing we get</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="w">       </span><span class="n">name</span><span class="w">               </span><span class="s">pOpt</span><span class="w">         </span><span class="s">pExp</span>
<span class="n">___________________</span><span class="w">    </span><span class="s">__________</span><span class="w">    </span><span class="s">_________</span>
<span class="p">{</span><span class="s">&#39;elyte_bruggeman&#39;</span><span class="p">}</span><span class="w">        </span><span class="mf">1.6149</span><span class="w">            </span><span class="mi">2</span>
<span class="p">{</span><span class="s">&#39;ne_k0&#39;</span><span class="w">          </span><span class="p">}</span><span class="w">    </span><span class="mf">4.2599e-11</span><span class="w">    </span><span class="mf">5.005e-10</span>
<span class="p">{</span><span class="s">&#39;pe_k0&#39;</span><span class="w">          </span><span class="p">}</span><span class="w">    </span><span class="mf">1.8927e-11</span><span class="w">    </span><span class="mf">5.005e-10</span>
<span class="p">{</span><span class="s">&#39;ne_vsa&#39;</span><span class="w">         </span><span class="p">}</span><span class="w">    </span><span class="mf">2.9014e+05</span><span class="w">     </span><span class="mf">5.05e+06</span>
<span class="p">{</span><span class="s">&#39;pe_vsa&#39;</span><span class="w">         </span><span class="p">}</span><span class="w">     </span><span class="mf">4.018e+05</span><span class="w">     </span><span class="mf">5.05e+06</span>
</pre></div>
</div>
<p>The match of the discharge voltage using the default setup is shown in
the figure below. It’s good towards the end, but not so much in the
beginning. Here</p>
<ul class="simple">
<li><p>E_0 is the voltage using the parameters from the initial guess</p></li>
<li><p>E_exp is the “experimental” voltage that we seek to match</p></li>
<li><p>E_opt is the voltage from the optimized parameters</p></li>
</ul>
<figure class="align-center">
<a class="reference external image-reference" href="_images/runParameterIdentification1.png"><img alt="_images/runParameterIdentification1.png" src="_images/runParameterIdentification1.png" style="width: 100%;" /></a>
</figure>
<p>Now we can uncomment the parts of the code that give a finer time
discretization and a stricter tolerance for BFGS as discussed
above. Running the program again results in a very good match, both in
the parameters and the discharge potential curve. Note that we reach
the <cite>boxLim</cite> for <cite>ne_k0</cite>, why a next step could be to change this.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">name</span><span class="w">               </span><span class="s">pOpt</span><span class="w">         </span><span class="s">pExp</span>
<span class="n">___________________</span><span class="w">    </span><span class="s">__________</span><span class="w">    </span><span class="s">_________</span>
<span class="p">{</span><span class="s">&#39;elyte_bruggeman&#39;</span><span class="p">}</span><span class="w">        </span><span class="mf">1.9998</span><span class="w">            </span><span class="mi">2</span>
<span class="p">{</span><span class="s">&#39;ne_k0&#39;</span><span class="w">          </span><span class="p">}</span><span class="w">         </span><span class="mf">1e-09</span><span class="w">    </span><span class="mf">5.005e-10</span>
<span class="p">{</span><span class="s">&#39;pe_k0&#39;</span><span class="w">          </span><span class="p">}</span><span class="w">    </span><span class="mf">3.4029e-10</span><span class="w">    </span><span class="mf">5.005e-10</span>
<span class="p">{</span><span class="s">&#39;ne_vsa&#39;</span><span class="w">         </span><span class="p">}</span><span class="w">    </span><span class="mf">2.4994e+06</span><span class="w">     </span><span class="mf">5.05e+06</span>
<span class="p">{</span><span class="s">&#39;pe_vsa&#39;</span><span class="w">         </span><span class="p">}</span><span class="w">    </span><span class="mf">4.7775e+06</span><span class="w">     </span><span class="mf">5.05e+06</span>
</pre></div>
</div>
<figure class="align-center">
<a class="reference external image-reference" href="_images/runParameterIdentification2.png"><img alt="_images/runParameterIdentification2.png" src="_images/runParameterIdentification2.png" style="width: 100%;" /></a>
</figure>
</section>
<section id="optimization-example">
<h2>Optimization example<a class="headerlink" href="#optimization-example" title="Permalink to this heading"></a></h2>
<p>Here we will present an example illustrating how the energy output of
a battery in one cycle can maximized by adjusting the porosity and the
operating current. The complete code is available at
<a class="reference external" href="https://github.com/BattMoTeam/BattMo/blob/dev/Examples/Optimisation/runBattery1DOptimize.m">runBattery1DOptimize</a>.</p>
<p>We start by clearing the workspace, closing figures and initializing the MRST modules.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Clear the workspace and close open figures</span>
<span class="nb">clear</span>
<span class="nb">close</span><span class="w"> </span><span class="nb">all</span>

<span class="c">% Load MRST modules</span>
<span class="n">mrstModule</span><span class="w"> </span><span class="s">add</span><span class="w"> </span><span class="s">ad-core</span><span class="w"> </span><span class="s">mrst-gui</span><span class="w"> </span><span class="s">mpfa</span><span class="w"> </span><span class="s">optimization</span>
</pre></div>
</div>
<p>For this example we set up a standard Li-ion battery with an NMC
cathode and graphite anode without currect collectors. At the moment,
we do not take into account thermal effects, and we use a simple
diffusion model. This means that the diffusion in the active material
is determined by evaluating an analytical function, in contrast to the
standard approach, where the diffusion is determined by solving a 1D
differential equation. The difference should not be that significant
in this case, and the ambitious reader is encouraged to investigate
this.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">jsonstruct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parseBattmoJson</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="s">&#39;ParameterData&#39;</span><span class="p">,</span><span class="s">&#39;BatteryCellParameters&#39;</span><span class="p">,</span><span class="s">&#39;LithiumIonBatteryCell&#39;</span><span class="p">,</span><span class="s">&#39;lithium_ion_battery_nmc_graphite.json&#39;</span><span class="p">));</span>
<span class="n">jsonstruct</span><span class="p">.</span><span class="n">include_current_collectors</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="n">jsonstruct</span><span class="p">.</span><span class="n">use_thermal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="c">% We define some shorthand names for simplicity.</span>
<span class="n">ne</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;NegativeElectrode&#39;</span><span class="p">;</span>
<span class="n">pe</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;PositiveElectrode&#39;</span><span class="p">;</span>
<span class="n">am</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;ActiveMaterial&#39;</span><span class="p">;</span>
<span class="n">cc</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;CurrentCollector&#39;</span><span class="p">;</span>
<span class="n">elyte</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Electrolyte&#39;</span><span class="p">;</span>
<span class="n">thermal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;ThermalModel&#39;</span><span class="p">;</span>
<span class="n">itf</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Interface&#39;</span><span class="p">;</span>
<span class="n">sd</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;SolidDiffusion&#39;</span><span class="p">;</span>
<span class="n">ctrl</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Control&#39;</span><span class="p">;</span>
<span class="n">sep</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Separator&#39;</span><span class="p">;</span>

<span class="n">jsonstruct</span><span class="p">.(</span><span class="n">ne</span><span class="p">).(</span><span class="n">am</span><span class="p">).</span><span class="n">diffusionModelType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;simple&#39;</span><span class="p">;</span>
<span class="n">jsonstruct</span><span class="p">.(</span><span class="n">pe</span><span class="p">).(</span><span class="n">am</span><span class="p">).</span><span class="n">diffusionModelType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;simple&#39;</span><span class="p">;</span>

<span class="n">inputparams</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">BatteryInputParams</span><span class="p">(</span><span class="n">jsonstruct</span><span class="p">);</span>

<span class="n">inputparams</span><span class="p">.(</span><span class="n">ctrl</span><span class="p">).</span><span class="n">useCVswitch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</pre></div>
</div>
<p>To avoid too much computational cost, we set up a P2D model.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">gen</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">BatteryGeneratorP2D</span><span class="p">();</span>

<span class="c">% Now, we update the inputparams with the properties of the grid.</span>
<span class="n">inputparams</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gen</span><span class="p">.</span><span class="n">updateBatteryInputParams</span><span class="p">(</span><span class="n">inputparams</span><span class="p">);</span>

<span class="c">%  Initialize the battery model.</span>

<span class="n">model</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Battery</span><span class="p">(</span><span class="n">inputparams</span><span class="p">);</span>
</pre></div>
</div>
<p>To avoid an initial strong shock to the system, we ramp-up the current
to the prescribed current using small time steps. An appropriate
default control (the procedures for how the battery is to be operated)
that does this is set up automatically by the built-in function
<cite>setupScheduleControl</cite>.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Smaller time steps are used to ramp up the current from zero to its</span>
<span class="c">% operational value. Larger time steps are then used for the normal</span>
<span class="c">% operation.</span>

<span class="n">CRate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">CRate</span><span class="p">;</span>
<span class="n">total</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1.2</span><span class="o">*</span><span class="nb">hour</span><span class="o">/</span><span class="n">CRate</span><span class="p">;</span>

<span class="n">n</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span>
<span class="n">dt</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">total</span><span class="o">*</span><span class="mf">0.7</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>
<span class="nb">step</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;val&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>

<span class="c">% Setup the control by assigning a source and stop function.</span>

<span class="n">control</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">setupScheduleControl</span><span class="p">();</span>

<span class="n">nc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">nst</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="nb">step</span><span class="p">.</span><span class="n">control</span><span class="p">);</span>
<span class="n">ind</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">floor</span><span class="p">(((</span><span class="mi">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">nst</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nst</span><span class="p">)</span><span class="o">*</span><span class="n">nc</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="nb">step</span><span class="p">.</span><span class="n">control</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ind</span><span class="p">;</span>
<span class="n">control</span><span class="p">.</span><span class="n">Imax</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">Imax</span><span class="p">;</span>
<span class="n">control</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">repmat</span><span class="p">(</span><span class="n">control</span><span class="p">,</span><span class="w"> </span><span class="n">nc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="n">schedule</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;control&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">control</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;step&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">step</span><span class="p">);</span>
</pre></div>
</div>
<p>Then we set up the nonlinear solver. To illustrate the capabilities of
the nonlinear solver we lower the default maximum number of iterations
and set a tolerance depending on the input current. The solver will
cut the time steps in half if the nonlinear system fails to converge,
resulting in so-called “ministeps”. When running the simulation, we
have the option to return values at these ministeps (see the call to
<cite>simulateScheduleAD</cite> below).</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">nls</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">NonLinearSolver</span><span class="p">();</span>

<span class="c">% Change the number of maximum nonlinear iterations</span>
<span class="n">nls</span><span class="p">.</span><span class="n">maxIterations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="c">% Change default behavior of nonlinear solver, in case of error</span>
<span class="n">nls</span><span class="p">.</span><span class="n">errorOnFailure</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="c">% Change tolerance for the nonlinear iterations</span>
<span class="n">model</span><span class="p">.</span><span class="n">nonlinearTolerance</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e-3</span><span class="o">*</span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">Imax</span><span class="p">;</span>

<span class="c">% Set verbosity</span>
<span class="n">model</span><span class="p">.</span><span class="n">verbose</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</pre></div>
</div>
<p>Given an initial state, we can now solve the system. Note that we pass
our nonlinear solver object and set <cite>OutputMinisteps=true</cite> as
options. We may also plot the resulting potential.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Setup the initial state</span>
<span class="n">initstate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">setupInitialState</span><span class="p">();</span>

<span class="c">% Run the simulation</span>
<span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">simulateScheduleAD</span><span class="p">(</span><span class="n">initstate</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;OutputMinisteps&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;NonLinearSolver&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">nls</span><span class="p">)</span>

<span class="n">ind</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">not</span><span class="p">(</span><span class="nb">isempty</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="n">states</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">states</span><span class="p">(</span><span class="n">ind</span><span class="p">);</span>

<span class="n">E</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="n">I</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="nb">time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>

<span class="n">doPlot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="n">doPlot</span>
<span class="w">    </span><span class="nb">figure</span><span class="p">;</span>
<span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="nb">time</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;*-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;displayname&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;initial&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;time  / h&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;voltage  / V&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">grid</span><span class="w"> </span><span class="s">on</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The energy of the cell is calculated by calling the <cite>EnergyOutput</cite>
function or simply by evaluating the integral E*I*dt using the
trapezoidal rule. The reason for introducing the <cite>EnergyOutput</cite>
function is that this will be used as objective function in the
optimization below.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">)</span><span class="w"> </span><span class="n">EnergyOutput</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">{:});</span>
<span class="n">vals</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">);</span>
<span class="n">totval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">([</span><span class="n">vals</span><span class="p">{:}]);</span>

<span class="c">% Compare with trapezoidal integral: they should be about the same</span>
<span class="n">totval_trapz</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">trapz</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">.*</span><span class="n">I</span><span class="p">);</span>
<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Rectangle rule: %g Wh, trapezoidal rule: %g Wh\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">totval</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">totval_trapz</span><span class="o">/</span><span class="nb">hour</span><span class="p">);</span>
</pre></div>
</div>
<p>Now we are ready to set up the free parameters in the optimization
problem. First we have the porosities of three parts of the battery:
the negative electrode, the separator and the positive
electrode. Since BattMo uses volume fractions instead of porisities,
we use a small class to update these, namely the <cite>PorositySetter</cite>
class. For each part, this class will set the corresponding volume
fraction (as well as update the effective electronic conductivities in
the case of the electrodes, since these depend on the volume fractions
as well). We will not discuss this class in more detail and use to the
set/get routines from this class to update the parameters:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">state0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">initstate</span><span class="p">;</span>
<span class="n">SimulatorSetup</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;schedule&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;state0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">state0</span><span class="p">);</span>

<span class="n">parameters</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>

<span class="n">paramsetter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">PorositySetter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">ne</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="p">,</span><span class="w"> </span><span class="n">pe</span><span class="p">});</span>

<span class="n">getporo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">notused</span><span class="p">)</span><span class="w"> </span><span class="n">paramsetter</span><span class="p">.</span><span class="n">getValues</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
<span class="n">setporo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">notused</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">paramsetter</span><span class="p">.</span><span class="n">setValues</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>

<span class="n">parameters</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addParameter</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">SimulatorSetup</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;name&#39;</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;porosity&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;belongsTo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;model&#39;</span><span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;boxLims&#39;</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.9</span><span class="p">]</span><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;location&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">}</span><span class="w">          </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;getfun&#39;</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="n">getporo</span><span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;setfun&#39;</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="n">setporo</span><span class="p">);</span>
</pre></div>
</div>
<p>In addition to the three porosities, we will also have the maximum
current <cite>Imax</cite> as a parameter in the optimization problem. This
parameter belongs to the <cite>schedule</cite> object. We use a ramp-up function
similar to the one setup by default (see <cite>schedule.control</cite>), but
with <cite>Imax</cite> to be set (variable <cite>v</cite>). Note also the range of <cite>Imax</cite>
set by the <cite>boxLims</cite>.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">setfun</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;Imax&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                  </span><span class="s">&#39;src&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">@(</span><span class="nb">time</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="n">rampupSwitchControl</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">rampupTime</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">lowerCutoffVoltage</span><span class="p">),</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                  </span><span class="s">&#39;stopFunction&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">.</span><span class="n">control</span><span class="p">.</span><span class="n">stopFunction</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                  </span><span class="s">&#39;CCDischarge&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="n">parameters</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addParameter</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">SimulatorSetup</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;name&#39;</span><span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Imax&#39;</span><span class="w">                       </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;belongsTo&#39;</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;schedule&#39;</span><span class="w">                   </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;boxLims&#39;</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">Imax</span><span class="o">*</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;location&#39;</span><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;control&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Imax&#39;</span><span class="p">}</span><span class="w">          </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;getfun&#39;</span><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="w">                           </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;setfun&#39;</span><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="n">setfun</span><span class="p">);</span>
</pre></div>
</div>
<p>Now we construct the function handle to the <cite>EnergyOutput</cite> function as objective functional. We also include a so-called hook – a function that is called after each optimization step which here plots the current, voltage, power and energy. The objective function also evaluates the gradient, as will perform a gradient-based optimization to reduce the number of costly model evalutations. The gradients are obtained by solving an adjoint problem.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">objmatch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">)</span><span class="w"> </span><span class="n">EnergyOutput</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">{:});</span>
<span class="k">if</span><span class="w"> </span><span class="n">doPlot</span>
<span class="w">    </span><span class="n">fn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">plotAfterStepIV</span><span class="p">;</span>
<span class="k">else</span>
<span class="w">    </span><span class="n">fn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>
<span class="k">end</span>
<span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">evalObjectiveBattmo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">objmatch</span><span class="p">,</span><span class="w"> </span><span class="n">SimulatorSetup</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;objScaling&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">totval</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;afterStepFn&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span>
</pre></div>
</div>
<p>The optimization routines require scaling or the parameters to <cite>[0, 1]</cite>. Here we simply use the original parameter values scaled, minus a constant. Worth noting that optimization problems may be sensitive to the initial parameters</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">p_base</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getScaledParameterVector</span><span class="p">(</span><span class="n">SimulatorSetup</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">);</span>
<span class="n">p_base</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p_base</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
</pre></div>
</div>
<p>Now we can perform the optimization by calling BFGS, a well-tested, effective gradient-based optimization algorithm. After performing the optimization, we evaluate the optimal voltage discharge profile and print the optimized parameters.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Solve the optimization problem using BFGS. One can adjust the</span>
<span class="c">% tolerances and the maxIt option to see how it effects the</span>
<span class="c">% optimum.</span>
<span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">p_opt</span><span class="p">,</span><span class="w"> </span><span class="n">history</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">unitBoxBFGS</span><span class="p">(</span><span class="n">p_base</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;gradTol&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-7</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;objChangeTol&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;maxIt&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">);</span>

<span class="c">% Compute objective at optimum</span>
<span class="n">setup_opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">updateSetupFromScaledParameters</span><span class="p">(</span><span class="n">SimulatorSetup</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">p_opt</span><span class="p">);</span>
<span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="w"> </span><span class="n">states_opt</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">simulateScheduleAD</span><span class="p">(</span><span class="n">setup_opt</span><span class="p">.</span><span class="n">state0</span><span class="p">,</span><span class="w"> </span><span class="n">setup_opt</span><span class="p">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">setup_opt</span><span class="p">.</span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;OutputMinisteps&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;NonLinearSolver&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">nls</span><span class="p">);</span>
<span class="n">time_opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">states_opt</span><span class="p">);</span>
<span class="n">E_opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">states_opt</span><span class="p">);</span>
<span class="n">I_opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">states_opt</span><span class="p">);</span>
<span class="n">totval_trapz_opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">trapz</span><span class="p">(</span><span class="n">time_opt</span><span class="p">,</span><span class="w"> </span><span class="n">E_opt</span><span class="o">.*</span><span class="n">I_opt</span><span class="p">);</span>

<span class="c">% Print optimal parameters</span>
<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Base and optimized parameters:\n&#39;</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="w">    </span><span class="c">% Get the original and optimized values</span>
<span class="w">    </span><span class="n">p0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">{</span><span class="n">k</span><span class="p">}.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">SimulatorSetup</span><span class="p">);</span>
<span class="w">    </span><span class="n">pu</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">{</span><span class="n">k</span><span class="p">}.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">setup_opt</span><span class="p">);</span>

<span class="w">    </span><span class="c">% Print</span>
<span class="w">    </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;%s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">{</span><span class="n">k</span><span class="p">}.</span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;%g %g\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">p0</span><span class="p">,</span><span class="w"> </span><span class="n">pu</span><span class="p">);</span>
<span class="k">end</span>

<span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Energy changed from %g to %g mWh\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">totval_trapz</span><span class="o">/</span><span class="nb">hour</span><span class="o">/</span><span class="n">milli</span><span class="p">,</span><span class="w"> </span><span class="n">totval_trapz_opt</span><span class="o">/</span><span class="nb">hour</span><span class="o">/</span><span class="n">milli</span><span class="p">);</span>
</pre></div>
</div>
<p>At the time of writing, we obtain (initial values in the left column, optimized values in the right column):</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">porosity</span><span class="w"> </span><span class="s">of</span><span class="w"> </span><span class="s">NE,</span><span class="w"> </span><span class="s">separator</span><span class="w"> </span><span class="s">and</span><span class="w"> </span><span class="s">PE</span>
<span class="mf">0.12163</span><span class="w"> </span><span class="mf">0.55</span>
<span class="mf">0.187132</span><span class="w"> </span><span class="mf">0.152395</span>
<span class="mf">0.472783</span><span class="w"> </span><span class="mf">0.100268</span>
<span class="n">Imax</span>
<span class="s">0.00986981</span><span class="w"> </span><span class="s">0.0147641</span>
</pre></div>
</div>
<p>The energy changes from 30.8822 to 44.0736 mWh.</p>
<p>Finally we may plot the voltage curves to compare the result from the
optimization procedure with the original.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">doPlot</span>
<span class="w">    </span><span class="c">% Plot</span>
<span class="w">    </span><span class="nb">figure</span><span class="p">;</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="s">on</span><span class="p">;</span><span class="w"> </span><span class="n">grid</span><span class="w"> </span><span class="s">on</span>
<span class="w">    </span><span class="n">E</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="w">    </span><span class="nb">time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="nb">time</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;*-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;displayname&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;initial&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="n">time_opt</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">E_opt</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;r*-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;displayname&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;optimized&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;time  / h&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;voltage  / V&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">legend</span><span class="p">;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The result is shown in the figure below.</p>
<figure class="align-center">
<a class="reference external image-reference" href="_images/runBattery1DOptimize.png"><img alt="_images/runBattery1DOptimize.png" src="_images/runBattery1DOptimize.png" style="width: 100%;" /></a>
</figure>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="thermal.html" class="btn btn-neutral float-left" title="Thermal Simulation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="octave.html" class="btn btn-neutral float-right" title="Note on Octave Support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2023.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>